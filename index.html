<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>#ŸÑÿ®ŸÜÿßŸÜ__ŸäŸÜÿ™ŸÅÿ∂</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <!-- COMMON TAGS -->
    <!-- Search Engine -->
    <meta name="description" content="Crowdsourced reports of the Lebanon 2019 protests">
    <meta name="image" content="https://lebanonprotests.xyz/siteimage.png">
    <!-- Schema.org for Google -->
    <meta itemprop="name" content="Lebanon protests 2019">
    <meta itemprop="description" content="Crowdsourced reports of the Lebanon 2019 protests">
    <meta itemprop="image" content="https://lebanonprotests.xyz/siteimage.png">
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Lebanon Protests 2019">
    <meta name="twitter:description" content="Crowdsourced reports of the Lebanon 2019 protests">
    <meta name="twitter:creator" content="@kamicut">
    <meta name="twitter:image:src" content="https://lebanonprotests.xyz/siteimage.png">
    <!-- Open Graph general (Facebook, Pinterest & Google+) -->
    <meta name="og:title" content="Lebanon protests">
    <meta name="og:description" content="Crowdsourced reports of the Lebanon 2019 protests">
    <meta name="og:image" content="https://lebanonprotests.xyz/siteimage.png">
    <meta name="og:url" content="https://lebanonprotests.xyz">
    <meta name="og:site_name" content="Lebanon Protests 2019">
    <meta name="og:type" content="website">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "helvetica";
        color: #333;
        line-height: 1.4
      }

        #hide {
          font-size: 0.5em;
        }

        #map-container {
          position: fixed;
          height: 100%;
          width: 100%;
        }

        #map {
          position: relative;
          height: 100%;
          width: 100%;
        }
        #about {
          padding: 10px;
          background-color: rgba(255, 255, 255, .7);
          text-align: right;
          font-size: 1.2em;
          direction: rtl
        }

        h1 {
          font-size: 2em;
        }

        @media only screen and (min-device-width : 320px) and (max-device-width : 480px) {
          body {
            font-size: 0.8em;
          }

          h1 {
            font-size: 1rem;
          }

        }
        footer {
          background-color: white;
          position: absolute;
          left: 0;
          bottom: 0;
          width: 100%;
          overflow: hidden;
        }
        ul {
          list-style-type: none;
          margin: 0;
          padding: 0;
          overflow: hidden;
          background-color: #333333;
        }

        li {
          float: left;
          color: #999;
          font-size: 0.8em;

        }

        li a,p {
          display: block;
          color: #999;
          margin: 0;
          text-align: center;
          padding: .5em;
          text-decoration: none;
        }

        footer li a:hover {
          background-color: #111111;
        }

    </style>
</head>

<body>
  <div id='about'>
    <div id="hide">[hide]</div>
    <div id="description">
      <h1>#ŸÑÿ®ŸÜÿßŸÜ__ŸäŸÜÿ™ŸÅÿ∂ </h1>
    </div>
    <div id="menubox">
    </div>
  </div>

  <div id="map-container">
    <div id='map'></div>
  </div>
  <footer>
    <ul>
      <li><a href="about.html">About</a></li>
      <li><a href=>Code and data</a></li>
      <li><a href="https://github.com/kamicut/lebanon-protests-2019">Code and data üíª</a></li>
      <li><a href="https://bit.ly/33GdlCR">Another Crowdsourced Mapüôå</a></li>
      <li><a>Updated 10/20/2019 4:47pm Lebanon time</a></li>

      <li id='menu' style="direction:ltr;text-align:left;">
        <p>
        <input id='kamicut/ck1vedq510l101cocnbgs1ira' type='radio' name='rtoggle' value='streets' checked>
        <label for='streets'>streets</label>
        <input id='kamicut/ck1vei9rg881c1cowmbobmb96' type='radio' name='rtoggle' value='satellite'>
        <label for='satellite'>satellite</label>
        </p>
      </li>
  </footer>

        <script>
            function addProtestsLayer(map) {
                map.addLayer({
                    id: 'geo_incidents',
                    type: "symbol",
                    source: {
                        "type": "geojson",
                        "data": "protests.geojson"
                    },
                    layout: {
                        "text-field": ["to-string", ["get", "protest location"]],
                        "icon-image": "marker-15",
                        "text-offset": [-0.5, 1],
                        "icon-size": 1,
                        "text-size": 15,
                        "text-allow-overlap": false,
                        "icon-allow-overlap": true
                    },
                    "paint": {
                        "text-color": "hsl(0, 50%, 90%)",
                        "text-halo-color": "hsl(0, 100%, 0%)",
                        "text-halo-width": 1
                    }
                }, )
            }

            function addProtestsHeatmap(map) {
                map.addLayer({
                    id: 'sat_incidents',
                    type: "heatmap",
                    source: {
                        "type": "geojson",
                        "data": "protests.geojson"
                    },
                    "paint": {
                        "heatmap-color": [
                            "interpolate",
                            ["linear"],
                            ["heatmap-density"],
                            0,
                            "hsla(27, 100%, 50%, 0)",
                            0.5,
                            "hsl(35, 100%, 50%)",
                            1,
                            "red"
                        ]
                    },
                }, )
            }

            function forEachLayer(map, text, cb) {
                map.getStyle().layers.forEach((layer) => {
                    if (!layer.id.includes(text)) return;

                    cb(layer);
                });
            }

            // Changing the map base style
            function changeStyle(map, style) {
                const savedLayers = [];
                const savedSources = {};
                const layerGroups = [
                    'sat_incidents',
                    'geo_incidents',
                ];

                layerGroups.forEach((layerGroup) => {
                    forEachLayer(map, layerGroup, (layer) => {
                        savedSources[layer.source] = map.getSource(layer.source).serialize();
                        savedLayers.push(layer);
                    });
                });

                map.setStyle(`mapbox://styles/${style}`);


                setTimeout(() => {
                    Object.entries(savedSources).forEach(([id, source]) => {
                        map.addSource(id, source);
                    });

                    savedLayers.forEach((layer) => {
                        map.addLayer(layer);
                    });
                }, 1000);
            }

            mapboxgl.accessToken = 'pk.eyJ1Ijoia2FtaWN1dCIsImEiOiJMVzF2NThZIn0.WO0ArcIIzYVioen3HpfugQ';
            mapboxgl.setRTLTextPlugin('https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js');

            var map = new mapboxgl.Map({
                container: 'map', // container id
                style: 'mapbox://styles/kamicut/ck1vedq510l101cocnbgs1ira',
                center: [35.413, 33.834], // starting position [lng, lat]
                zoom: 9 // starting zoom
            });

            map.on('load', function() {
                addProtestsHeatmap(map)
                addProtestsLayer(map)
            })

            var layerList = document.getElementById('menu');
            var inputs = layerList.getElementsByTagName('input');

            function switchLayer(layer) {
                var layerId = layer.target.id;
                changeStyle(map, layerId)
            }

            for (var i = 0; i < inputs.length; i++) {
                inputs[i].onclick = switchLayer;
            }

            // hide button
            var hideButton = document.querySelector('#hide')
            var menubox = document.querySelector('#menubox')
            var description = document.querySelector('#description')
            var menuBoxShow = true
            hideButton.onclick = function(e) {
                menuBoxShow = !menuBoxShow
                menubox.style = menuBoxShow ? "" : "display: none"
                description.style = menuBoxShow ? "" : "display:none"
                hideButton.innerHTML = menuBoxShow ? "[hide]" : "[show]"
            }

            // add popup
            // Create a popup, but don't add it to the map yet.
            var popup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: false
            });

            map.on('click', 'geo_incidents', function(e) {
                var coordinates = e.features[0].geometry.coordinates.slice();
                var description = 'ÿ∫Ÿäÿ± ŸÖŸàÿ´ŸÇ';
                if (e.features[0].properties.links !== "null") {
                    description = `<a target=_blank href=${e.features[0].properties.links}>ÿ±ÿßÿ®ÿ∑</a>`
                }

                // Ensure that if the map is zoomed out such that multiple
                // copies of the feature are visible, the popup appears
                // over the copy being pointed to.
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }

                // Populate the popup and set its coordinates
                // based on the feature found.
                popup.setLngLat(coordinates)
                    .setHTML(description)
                    .addTo(map);
            })

            map.on('mouseenter', 'geo_incidents', function(e) {
                // Change the cursor style as a UI indicator.
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'geo_incidents', function() {
                map.getCanvas().style.cursor = '';
            });

        </script>

</body>

</html>
